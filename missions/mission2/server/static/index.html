<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Smart Irrigation — Local Dashboard</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--text:#e8eefc;--muted:#9fb0d4;--acc:#7aa2ff;--good:#2ecc71;--warn:#f1c40f;--bad:#e74c3c}
  *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#13224a 0%,var(--bg) 40%) no-repeat fixed;color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;padding:24px;min-height:100vh}
  .wrap{max-width:1200px;margin:0 auto;display:grid;gap:18px}
  .header{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .left{display:flex;gap:12px;align-items:center}
  .title{font-weight:800;font-size:20px;margin:0}
  .muted{color:var(--muted);font-size:13px;margin:2px 0 0}
  .input{background:#0f1834;border:1px solid rgba(255,255,255,.08);color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;min-width:200px}
  .btn{background:linear-gradient(90deg,#7aa2ff,#67ffd2);color:#0a122c;border:none;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .grid{display:grid;gap:18px;grid-template-columns:360px 1fr}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.06),transparent 30%),var(--card);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:16px}
  .kv{display:grid;grid-template-columns:130px 1fr;gap:6px 10px;font-size:14px}
  .status{padding:6px 10px;border-radius:8px;font-size:12px;font-weight:800;display:inline-block}
  .ok{background:rgba(46,204,113,.15);border:1px solid rgba(46,204,113,.5)}
  .warn{background:rgba(241,196,15,.15);border:1px solid rgba(241,196,15,.5)}
  .bad{background:rgba(231,76,60,.15);border:1px solid rgba(231,76,60,.5)}
  .gauge{--thirst:0;--angle:calc(var(--thirst)*3.6deg);--hue:calc(120 - (var(--thirst)*1.2));width:260px;height:260px;border-radius:50%;background:conic-gradient(hsl(var(--hue) 90% 52%) 0 var(--angle),rgba(255,255,255,.08) var(--angle) 360deg);display:grid;place-items:center;margin:10px auto;position:relative}
  .gauge::before{content:"";position:absolute;inset:14px;border-radius:50%;background:radial-gradient(150px 120px at 50% 20%,rgba(255,255,255,.08),transparent 40%),#0e1633;border:1px solid rgba(255,255,255,.06)}
  .readout{text-align:center}.big{font-size:46px;font-weight:900;letter-spacing:.3px}
  .spark{height:170px;background:#0e1632;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;position:relative;overflow:hidden}
  .legend{display:flex;gap:12px;font-size:12px;color:var(--muted);margin-top:8px;flex-wrap:wrap}
  .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}.mo{background:#40e0d0}.th{background:#ff7b6e}.pu{background:#67ffd2}
  @media(max-width:980px){.grid{grid-template-columns:1fr}.gauge{width:220px;height:220px}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="left">
      <div>
        <div class="title">Smart Irrigation — Local Dashboard</div>
        <p class="muted" id="modelInfo">MQTT: …</p>
      </div>
    </div>
    <div>
      <input class="input" id="areaInput" value="area-tn-001"/>
      <button class="btn" id="applyArea">Apply Area</button>
      <button class="btn" id="toggleAuto">Auto: ON</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Soil Thirst</h3>
      <div class="gauge" id="gauge" style="--thirst:0">
        <div class="readout">
          <div class="big"><span id="thirstPct">0</span>%</div>
          <div class="muted"><span id="moistPct">100</span>% moisture</div>
          <div class="muted" id="tsTxt">—</div>
        </div>
      </div>
      <div>
        <button class="btn" id="pumpOn">Pump ON</button>
        <button class="btn" id="pumpOff" style="background:#2b2f43;color:#fff;border:1px solid rgba(255,255,255,.1)">Pump OFF</button>
      </div>
      <div style="margin-top:10px">
        <span class="status ok" id="statusBadge">OK</span>
      </div>
      <div class="kv" style="margin-top:10px">
        <div>Decision:</div><div id="decisionTxt">—</div>
        <div>Last Pump:</div><div id="lastPumpTxt">0</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>Live Inputs & History</h3><p class="muted" style="margin-top:0">Last 60 minutes</p></div>
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>

      <div class="kv">
        <div>Temperature</div><div><span id="tempTxt">—</span> °C</div>
        <div>Humidity</div><div><span id="rhTxt">—</span> %</div>
        <div>Water Level</div><div><span id="levelTxt">—</span> %</div>
        <div>N / P / K</div><div><span id="npkTxt">—</span> ppm</div>
      </div>

      <div class="spark" style="margin-top:12px">
        <svg id="sparkSvg" viewBox="0 0 800 170" preserveAspectRatio="none">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#40e0d0"/><stop offset="100%" stop-color="#2fbdb0"/></linearGradient>
            <linearGradient id="g2" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ff7b6e"/><stop offset="100%" stop-color="#db655a"/></linearGradient>
          </defs>
          <line x1="0" y1="160" x2="800" y2="160" stroke="rgba(255,255,255,.12)"/>
          <path id="pathMoist" d="" fill="none" stroke="url(#g1)" stroke-width="3"/>
          <path id="pathThirst" d="" fill="none" stroke="url(#g2)" stroke-width="2"/>
        </svg>
      </div>
      <div class="legend">
        <span><span class="dot mo"></span>Moisture %</span>
        <span><span class="dot th"></span>Thirst %</span>
      </div>
    </div>
  </div>
</div>

<script>
const areaInput = document.getElementById('areaInput');
const applyBtn  = document.getElementById('applyArea');
const autoBtn   = document.getElementById('toggleAuto');
const pumpOn    = document.getElementById('pumpOn');
const pumpOff   = document.getElementById('pumpOff');
const refreshBtn= document.getElementById('refreshBtn');

const modelInfo = document.getElementById('modelInfo');
const gauge     = document.getElementById('gauge');
const thirstEl  = document.getElementById('thirstPct');
const moistEl   = document.getElementById('moistPct');
const tsTxt     = document.getElementById('tsTxt');
const status    = document.getElementById('statusBadge');
const decTxt    = document.getElementById('decisionTxt');
const lastPump  = document.getElementById('lastPumpTxt');

const tempTxt   = document.getElementById('tempTxt');
const rhTxt     = document.getElementById('rhTxt');
const levelTxt  = document.getElementById('levelTxt');
const npkTxt    = document.getElementById('npkTxt');

const svg       = document.getElementById('sparkSvg');
const pathMoist = document.getElementById('pathMoist');
const pathThirst= document.getElementById('pathThirst');

let areaId = areaInput.value.trim();
let autoOn = true;
let series = [];

function setStatus(kind, msg){ status.className = "status " + kind; status.textContent = msg; }
function setGauge(m, ts){
  const moist = Math.max(0, Math.min(100, +m||0));
  const thirst= Math.round(100 - moist);
  thirstEl.textContent = thirst; moistEl.textContent = Math.round(moist);
  gauge.style.setProperty('--thirst', thirst);
  tsTxt.textContent = ts ? new Date(ts).toLocaleString() : "—";
}
function renderSpark(){
  if(series.length<2){ pathMoist.setAttribute('d',''); pathThirst.setAttribute('d',''); return; }
  const W=800,H=150, pad=10, xs = series.map((_,i)=> i*(W/(series.length-1)));
  const yPct = v => H - (v/100)*(H-pad);
  const mY = series.map(s=> yPct(+s.moist));
  const tY = series.map(s=> yPct(100 - +s.moist));
  const pathify = ys => ys.map((y,i)=> (i?'L':'M')+xs[i].toFixed(2)+','+(y+pad).toFixed(2)).join(' ');
  pathMoist.setAttribute('d', pathify(mY));
  pathThirst.setAttribute('d', pathify(tY));
}

async function ping(){
  const j = await (await fetch('/api/ping')).json();
  autoOn = !!j.auto; autoBtn.textContent = `Auto: ${autoOn?'ON':'OFF'}`;
  modelInfo.textContent = `MQTT ${j.mqtt} | thr on>${j.thr.on}, off<${j.thr.off}`;
}

async function latest(){
  const j = await (await fetch(`/api/latest?area_id=${encodeURIComponent(areaId)}`)).json();
  if(!j.ok || !j.data){ setStatus('warn','No data yet'); return; }
  const d = j.data;
  setGauge(d.moist, d.ts);
  tempTxt.textContent = d.temp_c==null?'—':(+d.temp_c).toFixed(1);
  rhTxt.textContent   = d.rh==null?'—':(+d.rh).toFixed(1);
  levelTxt.textContent= d.water_level==null?'—':(+d.water_level).toFixed(1);
  npkTxt.textContent  = `${(+d.N).toFixed(1)} / ${(+d.P).toFixed(1)} / ${(+d.K).toFixed(1)}`;
  lastPump.textContent= d.last_pump ?? 0;

  // decision text based on thirst hysteresis bands
  const thirst = 100 - (+d.moist);
  if (thirst < 30 && d.last_pump==1) { decTxt.textContent="Should be OFF (thirst<30)"; setStatus('ok','Hydrated'); }
  else if (thirst > 70 && d.last_pump==0) { decTxt.textContent="Should be ON (thirst>70)"; setStatus('bad','Parched'); }
  else { decTxt.textContent= d.last_pump? "ON (30–70%)":"OFF (30–70%)"; setStatus('warn','Drying'); }

  series.push({ts:d.ts, moist:+d.moist}); if(series.length>300) series.shift();
  renderSpark();
}

async function history(){
  const j = await (await fetch(`/api/history?area_id=${encodeURIComponent(areaId)}&minutes=60`)).json();
  series = (j.data||[]).map(d=>({ts:d.ts, moist:+d.moist}));
  renderSpark();
}

applyBtn.addEventListener('click', ()=>{ areaId = areaInput.value.trim()||'area-tn-001'; series=[]; history(); });
refreshBtn.addEventListener('click', history);
pumpOn.addEventListener('click', ()=> fetch(`/api/cmd?area_id=${encodeURIComponent(areaId)}&order=1`, {method:'POST'}));
pumpOff.addEventListener('click',()=> fetch(`/api/cmd?area_id=${encodeURIComponent(areaId)}&order=0`, {method:'POST'}));
autoBtn.addEventListener('click', async ()=>{
  const res = await fetch(`/api/auto?enabled=${autoOn?0:1}`, {method:'POST'}); const j = await res.json();
  autoOn = !!j.auto; autoBtn.textContent = `Auto: ${autoOn?'ON':'OFF'}`;
});

(async function boot(){
  await ping();
  await history();
  setInterval(ping, 20000);
  setInterval(latest, 1500);
})();
</script>
</body>
</html>
